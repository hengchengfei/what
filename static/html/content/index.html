<!doctype html>
<html ng-app="What">
<head>
    <meta charset="UTF-8">
    <title></title>
    
    <link rel="import" href="../include/link.html?__inline">
    <link rel="stylesheet" href="include/style.css?__inline">
</head>
<body>

    <div class="wait">
        <div></div>
    </div>

    <div class="page none" ng-controller="ContentCtrl">
        <div class="c_head">
            <img class="cicle" src="{{content.create_user.user_avatar}}" width="44" height="44">
            <p class="u_name" ng-bind="content.create_user.user_name"></p>
            <p class="c_time" ng-bind="content.create_time | time"></p>
        </div>

        <!-- start animation -->
            <!-- 我是时尚 ok -->
            <div class="c_img i_one" onclick="img_one(this)" ng-if="content.animation.animation_class == 'WhatAnimationEraseInOut'">
                <div index="1">
                    <img src="{{content.photos[0].url_middle}}">
                </div>
                <div index="2">
                    <img src="{{content.photos[1].url_middle}}">
                </div>
            </div>

            <!-- 萌化～ -->
            <div class="c_img i_two" onclick="img_two(this)" ng-if="content.animation.animation_class == 'WhatAnimationOglFlip'">
                <div index="1" data-image="url({{content.photos[0].url_middle}});"></div>
                <div index="2" data-image="url({{content.photos[1].url_middle}});"></div>
            </div>

            <!-- 不吃药打死你 ok -->
            <div class="c_img i_one" onclick="img_one(this)" ng-if="content.animation.animation_class == 'WhatAnimationRippleEffect'">
                <div index="1">
                    <img src="{{content.photos[0].url_middle}}">
                </div>
                <div index="2">
                    <img src="{{content.photos[1].url_middle}}">
                </div>
            </div>

            <!-- 好青年 ok -->
            <div class="c_img i_four" onclick="img_four(this)" ng-if="content.animation.animation_class == 'WhatAnimationOpenDoor'">
                <div class="i_four_one">
                    <div index="1">
                        <div style="background-image: url({{content.photos[0].url_middle}});"></div>
                    </div>
                    <div index="2">
                        <div style="background-image: url({{content.photos[1].url_middle}});"></div>
                    </div>
                </div>
                <div class="i_four_two">
                    <div index="3">
                        <div style="background-image: url({{content.photos[0].url_middle}});"></div>
                    </div>
                    <div index="4">
                        <div style="background-image: url({{content.photos[1].url_middle}});"></div>
                    </div>
                </div>
            </div>
            
            <!-- 我为何如此美 ok -->
            <div class="c_img i_five" onclick="img_five(this)" ng-if="content.animation.animation_class == 'WhatAnimationFallen'">
                <div index="1">
                    <div class="three_1" style="background-image:url({{content.photos[0].url_middle}});background-position: 0% 0%;"></div>
                    <div class="three_2" style="background-image:url({{content.photos[0].url_middle}});background-position: 33% 0%;"></div>
                    <div class="three_3" style="background-image:url({{content.photos[0].url_middle}});background-position: 66% 0%;"></div>
                    <div class="three_4" style="background-image:url({{content.photos[0].url_middle}});background-position: 99% 0%;"></div>

                    <div class="three_5"  style="background-image:url({{content.photos[0].url_middle}});background-position: 0% 20%;"></div>
                    <div class="three_6"  style="background-image:url({{content.photos[0].url_middle}});background-position: 33% 20%;"></div>
                    <div class="three_7"  style="background-image:url({{content.photos[0].url_middle}});background-position: 66% 20%;"></div>
                    <div class="three_8" style="background-image:url({{content.photos[0].url_middle}});background-position: 99% 20%;"></div>

                    <div class="three_9"  style="background-image:url({{content.photos[0].url_middle}});background-position: 0% 40%;"></div>
                    <div class="three_10"  style="background-image:url({{content.photos[0].url_middle}});background-position: 33% 40%;"></div>
                    <div class="three_11"  style="background-image:url({{content.photos[0].url_middle}});background-position: 66% 40%;"></div>
                    <div class="three_12"  style="background-image:url({{content.photos[0].url_middle}});background-position: 99% 40%;"></div>

                    <div class="three_13"  style="background-image:url({{content.photos[0].url_middle}});background-position: 0% 60%;"></div>
                    <div class="three_14"  style="background-image:url({{content.photos[0].url_middle}});background-position: 33% 60%;"></div>
                    <div class="three_15"  style="background-image:url({{content.photos[0].url_middle}});background-position: 66% 60%;"></div>
                    <div class="three_16"  style="background-image:url({{content.photos[0].url_middle}});background-position: 99% 60%;"></div>

                    <div class="three_17"  style="background-image:url({{content.photos[0].url_middle}});background-position: 0% 80%;"></div>
                    <div class="three_18"  style="background-image:url({{content.photos[0].url_middle}});background-position: 33% 80%;"></div>
                    <div class="three_19"  style="background-image:url({{content.photos[0].url_middle}});background-position: 66% 80%;"></div>
                    <div class="three_20"  style="background-image:url({{content.photos[0].url_middle}});background-position: 99% 80%;"></div>

                    <div class="three_21"  style="background-image:url({{content.photos[0].url_middle}});background-position: 0% 100%;"></div>
                    <div class="three_22"  style="background-image:url({{content.photos[0].url_middle}});background-position: 33% 100%;"></div>
                    <div class="three_23"  style="background-image:url({{content.photos[0].url_middle}});background-position: 66% 100%;"></div>
                    <div class="three_24"  style="background-image:url({{content.photos[0].url_middle}});background-position: 99% 100%;"></div>
                </div>
                <div index="2">
                    <div class="three_1" style="background-image:url({{content.photos[1].url_middle}});background-position: 0% 0%;"></div>
                    <div class="three_2" style="background-image:url({{content.photos[1].url_middle}});background-position: 33% 0%;"></div>
                    <div class="three_3" style="background-image:url({{content.photos[1].url_middle}});background-position: 66% 0%;"></div>
                    <div class="three_4" style="background-image:url({{content.photos[1].url_middle}});background-position: 99% 0%;"></div>

                    <div class="three_5"  style="background-image:url({{content.photos[1].url_middle}});background-position: 0% 20%;"></div>
                    <div class="three_6"  style="background-image:url({{content.photos[1].url_middle}});background-position: 33% 20%;"></div>
                    <div class="three_7"  style="background-image:url({{content.photos[1].url_middle}});background-position: 66% 20%;"></div>
                    <div class="three_8" style="background-image:url({{content.photos[1].url_middle}});background-position: 99% 20%;"></div>

                    <div class="three_9"  style="background-image:url({{content.photos[1].url_middle}});background-position: 0% 40%;"></div>
                    <div class="three_10"  style="background-image:url({{content.photos[1].url_middle}});background-position: 33% 40%;"></div>
                    <div class="three_11"  style="background-image:url({{content.photos[1].url_middle}});background-position: 66% 40%;"></div>
                    <div class="three_12"  style="background-image:url({{content.photos[1].url_middle}});background-position: 99% 40%;"></div>

                    <div class="three_13"  style="background-image:url({{content.photos[1].url_middle}});background-position: 0% 60%;"></div>
                    <div class="three_14"  style="background-image:url({{content.photos[1].url_middle}});background-position: 33% 60%;"></div>
                    <div class="three_15"  style="background-image:url({{content.photos[1].url_middle}});background-position: 66% 60%;"></div>
                    <div class="three_16"  style="background-image:url({{content.photos[1].url_middle}});background-position: 99% 60%;"></div>

                    <div class="three_17"  style="background-image:url({{content.photos[1].url_middle}});background-position: 0% 80%;"></div>
                    <div class="three_18"  style="background-image:url({{content.photos[1].url_middle}});background-position: 33% 80%;"></div>
                    <div class="three_19"  style="background-image:url({{content.photos[1].url_middle}});background-position: 66% 80%;"></div>
                    <div class="three_20"  style="background-image:url({{content.photos[1].url_middle}});background-position: 99% 80%;"></div>

                    <div class="three_21"  style="background-image:url({{content.photos[1].url_middle}});background-position: 0% 100%;"></div>
                    <div class="three_22"  style="background-image:url({{content.photos[1].url_middle}});background-position: 33% 100%;"></div>
                    <div class="three_23"  style="background-image:url({{content.photos[1].url_middle}});background-position: 66% 100%;"></div>
                    <div class="three_24"  style="background-image:url({{content.photos[1].url_middle}});background-position: 99% 100%;"></div>
                </div>
            </div>

            <!-- 自拍中勿打扰 -->
            <div class="c_img i_one" onclick="img_one(this)" ng-if="content.animation.animation_class == 'WhatAnimationYUGLPowDistortion'">
                <div index="1">
                    <img src="{{content.photos[0].url_middle}}">
                </div>
                <div index="2">
                    <img src="{{content.photos[1].url_middle}}">
                </div>
            </div>

            <!-- 基情噼里啪啦 ok -->
            <div class="c_img i_seven" onclick="img_seven(this)" ng-if="content.animation.animation_class == 'WhatAnimationYUGLSwap'">
                <div index="1">
                    <img src="{{content.photos[0].url_middle}}">
                </div>
                <div index="2">
                    <img src="{{content.photos[1].url_middle}}">
                </div>
            </div>

            <!-- 反差萌 -->
            <div class="c_img i_one" onclick="img_one(this)" ng-if="content.animation.animation_class == 'WhatAnimationYUGLFlyeye'">
                <div index="1">
                    <img src="{{content.photos[0].url_middle}}">
                </div>
                <div index="2">
                    <img src="{{content.photos[1].url_middle}}">
                </div>
            </div>
        <!-- end animation -->

        <ul class="c_topic">
            <li ng-repeat="ele in content.topics">
                <a href="?id=2" ng-bind="ele.name"></a>
            </li>
        </ul>
        <div class="c_zan">
            <em class="before">同感</em>
        </div>
        <div class="c_user">
            <p>我们都有同感</p>
            <ul class="u_list">
                <li ng-repeat="ele in content.zan_users | limitTo  : 5">
                    <img class="cicle" src="{{ele.user_avatar}}" width="40" height="40">
                </li>
            </ul>
        </div>
        <div class="c_comment">
            <p class="co_title">评论</p>
            <ul class="co_list">
                <li ng-repeat="ele in comment.datas">
                    <img class="cicle" src="{{ele.create_user.user_avatar}}" width="50px" height="50px">
                    <p class="co_name">Evie</p>
                    <p class="co_content" ng-bind="ele.text"></p>
                    <p class="co_time" ng-bind="ele.create_time | time"></p>
                </li>
            </ul>
        </div>
    </div>

    <link rel="import" href="../include/script.html?__inline">
    <link rel="import" href="../include/download/index.html?__inline">

    <script>
        var app = angular.module('What', [], angular.noop);

        app.controller('ContentCtrl', function ($scope, $http) {
                $scope.content = [];
                $scope.comment = [];

                $http.get("http://api.mkwhat.com/self-app/content/info?content_id=" + get_url_param("id"))
                .success(function (data) {
                    if ( ! data.data) {
                        get_content_error();
                        return;
                    }

                    $scope.content = data.data;

                    $(".c_img").css("height", $(".c_img").css("width"));
                    $(".page").removeClass("none");
                    $(".wait").addClass("none");
                    $("title").text(data.data.create_user.user_name + "的作品");

                    if ( ! data.data.zan_users || data.data.zan_users.length == 0) {
                        $(".c_user").addClass("none");
                    }

                    /* start add text to image */
                    if ( ! $("#canvas").length) {
                        $("body").prepend("<canvas id=\"canvas\" style=\"display: none;\"></canvas>");
                    }
                    var cvs = $("#canvas")[0], ctx = cvs.getContext("2d");
                    angular.forEach($scope.content.photos, function (item, key) {
                            var img = new Image();

                            img.onload = function () {
                                    cvs.width = img.width;
                                    cvs.height = img.height;

                                    ctx.clearRect(0, 0, cvs.width, cvs.height);
                                    ctx.font = "normal 16px microsoft yahei";

                                    ctx.drawImage(img, 0, 0, cvs.width, cvs.height);

                                    render_text(ctx, item.text, item.type, cvs.width, cvs.height);

                                    item.url_middle = cvs.toDataURL("image/png");
                                    $scope.content.photos[key] = item;
                                    $scope.$digest()
                            }
                            img.src = item.url_middle.replace("img.mkwhat.com", "www.mkwhat.com");
                            
                    });
                    /* end add text to image */

                    setTimeout(function() {
                        $(".i_two div").ripples({resolution: 128, dropRadius: 20, perturbance: 0.4,});
                    }, 100);
                })
                .error(get_content_error);

                $http.get("http://api.mkwhat.com/self-app/comment/list?content_id=" + get_url_param("id") + "&page=1")
                .success(function (data) {
                    if ( ! data.data) {
                        get_comment_error();
                        return;
                    }

                    $scope.comment = data.data;
                })
                .error(get_comment_error);
        });

        app.filter('time', function () {

                return function (input) {

                    if ( ! input) return "";

                    var time = (Date.now() - input) / 1000;

                    if (time <= 0) {
                        return "刚刚";
                    }
                    if (time < 60) {
                        return Math.floor(time) + "秒前";
                    }
                    if (time < 60 * 60) {
                        return Math.floor(time / 60) + "分钟前";
                    }
                    if (time < 60 * 60 * 24) {
                        return Math.floor(time / 60 / 60) + "小时前";
                    }

                    return Math.floor(time / 60 / 60 / 24) + "天前";
                };
        });

        function get_content_error () {
                $(".page").addClass("none");
        }

        function get_comment_error () {
                $(".c_comment").addClass("none");
        }
    </script>
</body>
</html>
